# THREE.InstancedMesh

## 概述

+ THREE.InstancedMesh 是 Three.js 中用于实例化大量相似几何体的一种高效方法

+ 它通过使用硬件加速的实例化技术来渲染多个共享同一几何体和材质的对象，从而减少了内存消耗和提高了渲染性能

# 实际应用

+ 非常适合用于渲染草地、森林、粒子系统等需要大量重复几何体的场景

## 构造函数

+ `new THREE.InstancedMesh(geometry, material, count)` 接受三个参数来定义实例化网格

  + geometry：共享的几何体，可以是 THREE.Geometry 或 THREE.BufferGeometry
  + material：共享的材质，可以是任何支持实例化的材质，如 THREE.MeshBasicMaterial 或 THREE.MeshPhysicalMaterial
  + count：实例的数量，即想要渲染的几何体实例数目

## 示例

+ 创建了一个包含1000个立方体实例的 THREE.InstancedMesh，并通过设置每个实例的位置来随机分布这些立方体

  ```js
  // 创建几何体
  const geometry = new THREE.BoxGeometry(1, 1, 1);

  // 创建材质
  const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });

  // 创建实例化网格，指定实例数量
  const instancedMesh = new THREE.InstancedMesh(geometry, material, 1000);

  // 为每个实例设置位置
  for (let i = 0; i < 1000; i++) {
    const x = (Math.random() - 0.5) * 20;
    const y = (Math.random() - 0.5) * 20;
    const z = (Math.random() - 0.5) * 20;
    const matrix = new THREE.Matrix4();
    matrix.makeTranslation(x, y, z);
    instancedMesh.setMatrixAt(i, matrix);
  }

  // 设置需要更新实例数据
  instancedMesh.instanceMatrix.needsUpdate = true;

  // 将实例化网格添加到场景中
  scene.add(instancedMesh);
  ```

+ 循环设置meshes中每一个小球的位置和颜色

  + 先定义一个变量index作为每一个小球的索引ID，初始值为0
  + 定义一个变量white，用于存放Threejs中的颜色
  + 定义一个offset，用于存放偏移量，即两个小球之间的间隔
  + 定义一个四维矩阵用于存放物体的位置
  + 然后通过三层for循环遍历每一个小球，并设置其位置和颜色

  ```js
  let amount = 10;
  const geometry = new THREE.IcosahedronGeometry(0.5,5);
  const material = new THREE.MeshPhongMaterial({color:0xffffff});
  const meshes = new THREE.InstancedMesh(geometry,material,amount * 100);

  // 定义颜色
  <!-- let white = new THREE.Color().setHex(0xffffff); -->

  // 定义每个小球位置的偏移量
  const offset = (amount -1 ) / 2 //4.5,即每个小球间隔4.5
  // 转换矩阵，
  const matrix = new THREE.Matrix4()
  for(let i = 0 ; i < amount; i++) {
    for(let j = 0; j < amount; j++) {
      for(let k = 0; k < amount; k++) {

        // 设置matrix的位置，根据偏移量
        matrix.setPosition(offset - i, offset - j, offset - k) //-4.5 ~ 4.5
        // 将index和matrix赋值给meshes
        meshes.setMatrixAt(index,matrix)

        // 设置每个小球的颜色
        let white = new THREE.Color().setHex(Math.random() * 0xffffff);
        meshes.setColorAt(index,white)
        index = index + 1
      }
    }
  }
  scene.add(meshes)
  ```

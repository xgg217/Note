# navigator.sendBeacon

## 概述

+ 可用于通过 HTTP POST 将少量数据 异步 传输到 Web 服务器。

+ 它主要用于将统计数据发送到 Web 服务器，同时避免了用传统技术（如：XMLHttpRequest）发送分析数据的一些问题

## 语法

+ 语法

  ```js
  navigator.sendBeacon(url);
  navigator.sendBeacon(url, data);
  ```

+ 参数

  + url url 参数表明 data 将要被发送到的网络地址

  + data 可选 data 参数是将要发送的 ArrayBuffer、ArrayBufferView、Blob、DOMString、FormData 或 URLSearchParams 类型的数据

+ 返回值 当用户代理成功把数据加入传输队列时，sendBeacon() 方法将会返回 true，否则返回 false

  + sendBeacon 如果成功进入浏览器的发送队列后，会返回true；如果受到队列总数、数据大小的限制后，会返回false
  + 返回ture后，只是表示进入了发送队列，浏览器会尽力保证发送成功，但是否成功了，不会再有任何返回值

## 优势

+ 相较于img标签，使用navigator.sendBeacon会更规范，数据传输上可传输资源类型会更多
+ 对于ajax在页面卸载时上报，ajax有可能没上报完，页面就卸载了导致请求中断，因此ajax处理这种情况时必须作为同步操作
+ sendBeacon是异步的，不会影响当前页到下一个页面的跳转速度，且不受同域限制。这个方法还是异步发出请求，但是请求与当前页面脱离关联，作为浏览器的任务，因此可以保证会把数据发出去，不拖延卸载流程

## 实际使用

+ 在会话结束时发送统计数据:网站通常希望在用户完成页面浏览后向服务器发送分析或诊断数据，最可靠的方法是在 visibilitychange 事件发生时发送数据：

  ```js
  document.addEventListener("visibilitychange", function logData() {
    if (document.visibilityState === "hidden") {
      navigator.sendBeacon("/log", analyticsData);
    }
  });
  ```

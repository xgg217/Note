# 综合

## 访问被选择的文件

+ 访问被选择的文件

  ```html
  <input type="file" id="input" multiple />

  <script>
  const selectedFile = document.getElementById("input").files[0];
  const inputElement = document.getElementById("input");
  inputElement.addEventListener("change", handleFiles, false);
  function handleFiles() {
    const fileList = this.files; /* 现在你可以处理文件列表 */
  }
  </script>
  ```

## 显示文件大小

+ 显示文件大小

  ```html
  <form name="uploadForm">
    <div>
      <input id="uploadInput" type="file" multiple />
      <label for="fileNum">选择的文件数量：</label>
      <output id="fileNum">0</output>；
      <label for="fileSize">总大小：</label>
      <output id="fileSize">0</output>
    </div>
    <div><input type="submit" value="上传文件" /></div>
  </form>

  <script>
    const uploadInput = document.getElementById("uploadInput");
    uploadInput.addEventListener(
      "change",
      () => {
        // 计算总大小
        let numberOfBytes = 0;
        for (const file of uploadInput.files) {
          numberOfBytes += file.size;
        }

        // 近似到最接近的前缀单位
        const units = [
          "B",
          "KiB",
          "MiB",
          "GiB",
          "TiB",
          "PiB",
          "EiB",
          "ZiB",
          "YiB",
        ];
        const exponent = Math.min(
          Math.floor(Math.log(numberOfBytes) / Math.log(1024)),
          units.length - 1,
        );
        const approx = numberOfBytes / 1024 ** exponent;
        const output =
          exponent === 0
            ? `${numberOfBytes} 字节`
            : `${approx.toFixed(3)} ${
                units[exponent]
              }（${numberOfBytes} 字节）`;

        document.getElementById("fileNum").textContent =
          uploadInput.files.length;
        document.getElementById("fileSize").textContent = output;
      },
      false,
    );
  </script>
  ```

## 通过 click() 方法使用隐藏的文件 input 元素

+ 你可以隐藏公认难看的文件 `<input>` 元素并显示你自己的界面来打开文件选择器，然后显示哪个或哪些文件被用户选中了
+ 你可以通过给 input 元素添加 `display:none` 的样式，再调用 `<input>` 元素的 `click()` 方法来实现

  ```html
  <input
    type="file"
    id="fileElem"
    multiple
    accept="image/*"
    style="display:none" />

  <button id="fileSelect" type="button">选择一些文件</button>

  <script>
    const fileSelect = document.getElementById("fileSelect");
    const fileElem = document.getElementById("fileElem");

    fileSelect.addEventListener(
      "click",
      (e) => {
        if (fileElem) {
          fileElem.click();
        }
      },
      false,
    );
  </script>
  ```

## 使用 label 元素来触发一个隐藏的文件 input 元素

+ 为了允许在不使用 JavaScript（click() 方法）的情况下打开文件选择器，可以使用 <label> 元素
+ 注意，在这种情况下，input 元素不能用 display: none 来隐藏（也不能用 visibility: hidden），否则标签就不具有键盘无障碍性

  ```html
  <input
    type="file"
    id="fileElem"
    multiple
    accept="image/*"
    class="visually-hidden" />
  <label for="fileElem">选择一些文件</label>

  <style>
    .visually-hidden {
      clip: rect(0 0 0 0);
      clip-path: inset(50%);
      height: 1px;
      overflow: hidden;
      position: absolute;
      white-space: nowrap;
      width: 1px;
    }

    input.visually-hidden:is(:focus, :focus-within) + label {
      outline: thin dotted;
    }
  </style>
  ```

## 使用拖放来选择文件

+ 可以让用户将文件拖拽到你的 web 应用中

  ```js
  let dropbox;

    dropbox = document.getElementById("dropbox");
    dropbox.addEventListener("dragenter", dragenter, false);
    dropbox.addEventListener("dragover", dragover, false);
    dropbox.addEventListener("drop", drop, false);

  function dragenter(e) {
    e.stopPropagation();
    e.preventDefault();
  }

  function dragover(e) {
    e.stopPropagation();
    e.preventDefault();
  }

  function drop(e) {
    e.stopPropagation();
    e.preventDefault();

    const dt = e.dataTransfer;
    const files = dt.files;

    handleFiles(files);
  }
  ```

## 显示用户选择的图片的缩略图

+ 显示用户选择的图片的缩略图

  ```js
  function handleFiles(files) {
    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      if (!file.type.startsWith("image/")) {
        continue;
      }

      const img = document.createElement("img");
      img.classList.add("obj");
      img.file = file;
      preview.appendChild(img); // 假设“preview”就是用来显示内容的 div

      const reader = new FileReader();
      reader.onload = (e) => {
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }
  ```

## 使用对象 URL 来显示图片

+ 使用对象 URL 来显示图片

  ```html
  <input
    type="file"
    id="fileElem"
    multiple
    accept="image/*"
    style="display:none" />
  <a href="#" id="fileSelect">选择一些文件</a>
  <div id="fileList">
    <p>没有选择任何文件！</p>
  </div>

  <script>

  const fileSelect = document.getElementById("fileSelect"),
  fileElem = document.getElementById("fileElem"),
  fileList = document.getElementById("fileList");

  fileSelect.addEventListener(
    "click",
    (e) => {
      if (fileElem) {
        fileElem.click();
      }
      e.preventDefault(); // 避免导航至“#”
    },
    false,
  );

  fileElem.addEventListener("change", handleFiles, false);

  function handleFiles() {
    fileList.textContent = "";
    if (!this.files.length) {
      const p = document.createElement("p");
      p.textContent = "没有选择任何文件！";
      fileList.appendChild(p);
    } else {
      const list = document.createElement("ul");
      fileList.appendChild(list);
      for (let i = 0; i < this.files.length; i++) {
        const li = document.createElement("li");
        list.appendChild(li);
        const img = document.createElement("img");
        img.src = URL.createObjectURL(this.files[i]);
        img.height = 60;
        img.onload = () => {
          URL.revokeObjectURL(img.src);
        };
        li.appendChild(img);
        const info = document.createElement("span");
        info.textContent = `${this.files[i].name}：${this.files[i].size} 字节`;
        li.appendChild(info);
      }
    }
  }
  </script>
  ```

## 上传一个用户选择的文件

+ 上传一个用户选择的文件

  ```js
  function sendFiles() {
    const imgs = document.querySelectorAll(".obj");

    for (let i = 0; i < imgs.length; i++) {
      new FileUpload(imgs[i], imgs[i].file);
    }
  }

  function FileUpload(img, file) {
    const reader = new FileReader();
    this.ctrl = createThrobber(img);
    const xhr = new XMLHttpRequest();
    this.xhr = xhr;

    const self = this;
    this.xhr.upload.addEventListener(
      "progress",
      (e) => {
        if (e.lengthComputable) {
          const percentage = Math.round((e.loaded * 100) / e.total);
          self.ctrl.update(percentage);
        }
      },
      false,
    );

    xhr.upload.addEventListener(
      "load",
      (e) => {
        self.ctrl.update(100);
        const canvas = self.ctrl.ctx.canvas;
        canvas.parentNode.removeChild(canvas);
      },
      false,
    );
    xhr.open(
      "POST",
      "https://demos.hacks.mozilla.org/paul/demos/resources/webservices/devnull.php",
    );
    xhr.overrideMimeType("text/plain; charset=x-user-defined-binary");
    reader.onload = (evt) => {
      xhr.send(evt.target.result);
    };
    reader.readAsBinaryString(file);
  }

  function createThrobber(img) {
    const throbberWidth = 64;
    const throbberHeight = 6;
    const throbber = document.createElement("canvas");
    throbber.classList.add("upload-progress");
    throbber.setAttribute("width", throbberWidth);
    throbber.setAttribute("height", throbberHeight);
    img.parentNode.appendChild(throbber);
    throbber.ctx = throbber.getContext("2d");
    throbber.ctx.fillStyle = "orange";
    throbber.update = (percent) => {
      throbber.ctx.fillRect(
        0,
        0,
        (throbberWidth * percent) / 100,
        throbberHeight,
      );
      if (percent === 100) {
        throbber.ctx.fillStyle = "green";
      }
    };
    throbber.update(0);
    return throbber;
  }
  ```

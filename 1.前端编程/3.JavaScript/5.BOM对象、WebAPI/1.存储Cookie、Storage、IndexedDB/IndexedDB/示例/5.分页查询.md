# 分页查询

## 通过索引和游标分页查询

+ IndexedDB分页查询不像MySQL分页查询那么简单，没有提供现成的API，如limit等，所以需要我们自己实现分页

+ 到了IndexedDB的一个API advance

  + 该函数可以让我们的游标跳过多少条开始查询。假如我们的额分页是每页10条数据，现在需要查询第2页，那么我们就需要跳过前面10条数据，从11条数据开始查询，直到计数器等于10，那么我们就关闭游标，结束查询

  ```js
  /**
   * 通过索引和游标分页查询记录
   * @param {object} db 数据库实例
   * @param {string} storeName 仓库名称
   * @param {string} indexName 索引名称
   * @param {string} indexValue 索引值
   * @param {number} page 页码
   * @param {number} pageSize 查询条数
   */
  export function cursorGetDataByIndexAndPage(
    db: IDBDatabase,
    storeName: string,
    indexName: string,
    indexValue: string,
    page: number,
    pageSize: number,
  ) {
    return new Promise((res, rej) => {
      const list: any[] = []; // 存储当前页分页数据
      let counter = 0; // 计数器
      let isPass = true; // 是否跳过多少条查询
      // var store = db.transaction(storeName, "readwrite").objectStore(storeName); // 仓库对象
      var request = db.transaction(storeName, "readwrite").objectStore(storeName).openCursor(); // 创建一个指针对象（目前是指向第一条数据）

      request.onsuccess = function (e) {
        // @ts-ignore
        var cursor = e.target.result;

        // 是否要跳过一些数据
        if (page > 1 && isPass) {
          isPass = false;
          cursor.advance((page - 1) * pageSize); // 跳过多少条
          return;
        }

        if (cursor) {
          // 必须要检查
          list.push(cursor.value);
          counter++;

          // 当前页数据还没有结束
          if (counter < pageSize) {
            cursor.continue(); // 遍历了存储对象中的所有内容
          } else {
            cursor = null; // 遍历结束
            console.log("分页查询结果", list);
            res(list);
          }
        } else {
          console.log("分页查询结果", list);
          res(list);
        }
      };
      request.onerror = function (e) {
        rej(e);
      };
    });
  }
  ```


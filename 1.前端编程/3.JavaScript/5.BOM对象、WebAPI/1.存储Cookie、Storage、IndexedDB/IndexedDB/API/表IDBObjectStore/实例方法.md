# 实例方法

## 概述

+ 操作数据

  ```js
  request.onsuccess = (event) => {
    console.log('打开成功');

    const db = event.target.result;

    // 打开表（当前可以 读 + 写）
    const transaction = db.transaction(['person'], 'readwrite');

    // 获取表
    const store1 = transaction.objectStore('person');

    // 增加数据
    // store1.add({ name: "测试2", age: 28 }, '用户2')
    // store1.add({ name: "测试3", age: 38 }, '用户3')

    // 删除数据
    store1.delete('用户2')


  };
  ```

## add() 新增

+ 语法

  ```js
  add(value)
  add(value, key)
  ```

+ 参数

  + value 需要存储的值
  + key 主键。如果省略 默认为 `null`

+ 返回值 一个 IDBRequest 对象，在该操作对象中触发与此相关的后续事件

  ```js
  objectStore.add({ name: "测试", age: 18 }, '用户1')
  ```

  ```js
  function add() {
    const request = db.transaction(['person'], 'readwrite')
      .objectStore('person')
      .add({ id: 1, name: 'zlm', age: 24, email: '2396307772@qq.com'});

    request.onsuccess = function (event) {
      console.log('写入数据成功', event)
    };
    request.onerror = function (event) {
      console.log('写入数据失败',event)
    }
  }
  ```

## clear()

+ 删除当前对象仓库的所有记录
+ 该方法返回一个 IDBRequest 对象

  ```js
  // 不需要参数
  objectStore.clear()
  ```

## count() 计算记录的数量

+ 语法

  ```js
  count()
  count(query)
  ```

+ 参数

  + query

+ 返回值 不带参数时，该方法返回当前对象仓库的所有记录数量。如果主键或 IDBKeyRange 对象作为参数，则返回对应的记录数量

## createIndex() 添加索引

+ 添加索引
+ 该方法必须仅从事务调用模式回调

+ 语法

  ```js
  createIndex(indexName, keyPath)
  createIndex(indexName, keyPath, options)
  ```

+ 参数

  + indexName 要创建的索引名称。注意，可以创建一个空名索引
  + keyPath 主键
  + options 配置对象（可选）

    + unique 是否唯一 如果设为 `true` 将不允许重复的值

    + multiEntry 如果设为 `true` 对于有多个值的主键数组，每个值将在索引里面新建一个条目，否则主键数组对应一个条目

+ 返回值

  + 一个IDBIndex对象：新创建的索引


  ```js
  // 假定对象仓库中的数据记录都是如下的person类型
  var person = {
    name: name,
    email: email,
    created: new Date()
  };
  ```

  ```js
  const request = indexedDB.open(dbName, version);

  request.onupgradeneeded = function (event) {
    db = (event.target as IDBOpenDBRequest).result; // 数据库对象

    // 可以指定这个对象的某个属性来建立索引
    const store = db.createObjectStore("people", {
      // keyPath: "id", // 这是主键
      autoIncrement: true, // 实现自增
    });

    // name属性不是唯一值
    store.createIndex('name', 'name', { unique: false });

    // email属性是唯一值
    store.createIndex('email', 'email', { unique: true });

  };
  ```

## delete() 删除

+ 语法

  ```js
  objectStore.delete(Key)
  ```

+ 参数

  + key 主键

+ 删除

  ```js
  function remove() {
    const request = db.transaction(['person'])
      .objectStore('person')
      .delete(1);

    // 删除数据成功的回调函数
    request.onsuccess = function (event) {
      console.log('删除数据成功', event)
    }
  }
  ```


## deleteIndex() 于删除指定的索引

+ 该方法只能在VersionChange监听函数里面调用

  ```js
  objectStore.deleteIndex(indexName)
  ```


## get() 获取数据

+ 语法

  ```js
  get(key)
  ```

+ 参数

  + key 主键或键范围

+ 返回值 触发与此操作相关的后续事件的 IDBRequest 对象

  ```js
  function read() {
    const transaction = db.transaction['person'];
    const objectStore = transaction.objectStore('person')
    const request = objectStore.get(1);

    request.onerror = function (event) {
      console.log('读取事务失败',event)
    }

    request.onsuccess = function (event) {
      if (request.result) {
        console.log('Name', + request.result.name)
        console.log('Age', + request.result.age)
        console.log('Email', + request.result.email)
      } else {
        console.log('未获取数据记录')
      }
      console.log('读取成功事件', event)
    }
  }
  ```


## getAll() 查询所有

+ 适用于数据量较小的场景；若需处理大量数据，建议结合游标（openCursor）进行分页遍历，避免内存压力

+ 语法

  ```js
  getAll()
  getAll(query)
  getAll(query, count)
  getAll(options)
  ```

+ 参数

  + query 指定键或 IDBKeyRange 对象，用于限制返回的记录范围。例如，使用 IDBKeyRange.only(key) 精确匹配某个主键
  + count 指定返回的最大记录数量，适用于 query 为范围查询时，避免返回过多数据
  + options

  ```js
  // 获取所有记录
  objectStore.getAll();

  // 获取所有符合指定主键或 IDBKeyRange 的记录
  objectStore.getAll(query);

  // 指定获取记录的数量
  objectStore.getAll(query, count)
  ```

  ```js
  function read() {
    const transaction = db.transaction['person'];
    const objectStore = transaction.objectStore('person')
    const request = objectStore.getAll();

    request.onerror = function (event) {
      console.log('读取事务失败',event)
    }

    request.onsuccess = function (event) {
      if (request.result) {
        console.log('Name', + request.result.name)
        console.log('Age', + request.result.age)
        console.log('Email', + request.result.email)
      } else {
        console.log('未获取数据记录')
      }
      console.log('读取成功事件', event)
    }
  }
  ```

## getAllKeys() 获取所有符合条件的主键

+ 语法

  ```js
  getAllKeys()
  getAllKeys(query)
  getAllKeys(query, count)
  getAllKeys(options)
  ```

## getKey() 获取主键

+ 用于获取主键

  ```js
  getKey(key)
  ```

+ 参数

  + key 可以是主键值或 IDBKeyRange 对象


## index()

+ 返回指定名称的索引对象 IDBIndex

  ```js
  index(name)
  ```

## openCursor() 打开（创建）指针

+ 打开（创建）指针
+ 默认指向第一条数据

  ```js
  // 创建一个事务
  var transaction = db.transaction(['users'], 'readonly');

  // 获取对象存储空间
  var store = transaction.objectStore('users');

  // 打开游标
  var cursorRequest = store.openCursor();

  const list = [];

  // 游标遍历数据的回调函数（会多从触发）
  cursorRequest.onsuccess = function(event) {
    var cursor = event.target.result;

    if (cursor) {
      list.push(cursor.value);

      var user = cursor.value;
      console.log('User:', user);

      // 移动到下一条数据
      cursor.continue();
    }
  };

   // 提交事务
  transaction.oncomplete = function(event) {
    db.close();
  };
  ```

## openKeyCursor()


## put() 更新或插入

+ 更新现有记录，若记录不存在则插入

+ 语法

  ```js
  put(item)
  put(item, key)
  ```

+ 参数

  + item 新数据
  + key 主键 只在自动递增时才有必要提供，因为那时主键不包含在数据值里面

  ```js
  objectStore.put({ id: 1, name: 'John Updated' });
  ```

  ```js
  function update() {
    const request = db.transaction(['person'], 'readwrite')
      .objectStore('person')
      .put({ id: 1, name: '张四', age: 32, email: '239630772@qq.com'});

    request.onsuccess = function (event) {
      console.log('更新数据成功', event)
    }

    request.onerror = function (event) {
      console.log('没有获取到更多的数据', event)
    }
  }
  ```

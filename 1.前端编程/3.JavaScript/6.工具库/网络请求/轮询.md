# è½®è¯¢

## è§£å†³æ–¹æ¡ˆå’Œåº“

+ è§£å†³æ–¹æ¡ˆå’Œåº“

  ![alt text](images/è§£å†³æ–¹æ¡ˆ.png)

## æ–¹æ¡ˆ1 æ¨èé¦–é€‰ï¼švue-requestï¼ˆä¸“ä¸ºVue3è®¾è®¡ï¼‰

+ npm install vue-request

+ code

  ```html
  <script setup>
  import { useRequest } from 'vue-request';

  // è½®è¯¢è·å–æ•°æ®ç¤ºä¾‹
  const { data, loading } = useRequest(
    () => axios.get('/api/data'),
    {
      // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
      pollingInterval: 3000,
      // é”™è¯¯é‡è¯•ç­–ç•¥
      pollingWhenHidden: false, // é¡µé¢éšè—æ—¶æš‚åœ
      pollingErrorRetryCount: 3
    }
  );
  </script>

  <template>
    <div v-if="loading">åŠ è½½ä¸­...</div>
    <div v-else>{{ data }}</div>
  </template>
  ```

## æ–¹æ¡ˆ2 åŸç”Ÿæ–¹æ¡ˆï¼šä½¿ç”¨ Composition API å°è£…

+ ä½¿ç”¨ Composition API å°è£…

  ```js
  // utils/usePolling.ts
  import { ref, onUnmounted } from'vue';

  exportfunction usePolling<T>(fn: () => Promise<T>, interval: number) {
    const data = ref<T>();
    const error = ref<Error>();
    const isPolling = ref(true);

    let timer: number;

    const execute = async () => {
      try {
        data.value = await fn();
      } catch (err) {
        error.value = err asError;
      } finally {
        if (isPolling.value) {
          timer = setTimeout(execute, interval);
        }
      }
    };

    const stop = () => {
      isPolling.value = false;
      clearTimeout(timer);
    };

    // è‡ªåŠ¨å¼€å§‹
    execute();

    // ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†
    onUnmounted(stop);

    return { data, error, stop };
  }
  ```

+ ä½¿ç”¨

  ```js
  <script setup>
  import { usePolling } from './utils/usePolling';

  const { data, stop } = usePolling(
    () => fetch('/api/data').then(r => r.json()),
    5000
  );
  </script>
  ```

## æ–¹æ¡ˆ3 è½»é‡çº§æ–¹æ¡ˆï¼š@vueuse/coreï¼ˆæ¨èç»„åˆå¼APIé¡¹ç›®ï¼‰

+ `@vueuse/core`

  ```html
  <script setup>
  import { useIntervalFn } from '@vueuse/core';

  const data = ref();
  const error = ref();

  // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
  const { pause, resume } = useIntervalFn(async () => {
    try {
      data.value = await axios.get('/api/data');
    } catch (err) {
      error.value = err;
      pause(); // å‡ºé”™æ—¶æš‚åœ
    }
  }, 5000, { immediate: true });
  </script>
  ```

## æ–¹æ¡ˆ3 RxJS æ–¹æ¡ˆï¼ˆé€‚åˆå¤æ‚åœºæ™¯ï¼‰

+ code

  ```html
  <script setup>
  import { interval, switchMap } from 'rxjs';
  import { useObservable } from '@vueuse/rxjs';

  const poll$ = interval(3000).pipe(
    switchMap(() => from(axios.get('/api/data')))
  );

  const data = useObservable(poll$);
  </script>
  ```

## é€‰å‹å»ºè®®

+ ç®€å•åœºæ™¯
  ğŸ‘‰ ä½¿ç”¨ @vueuse/core çš„ useIntervalFn
  âœ… ä¼˜ç‚¹ï¼šæ— éœ€é¢å¤–ä¾èµ–ï¼Œç»„åˆå¼APIå‹å¥½
  âš ï¸ æ³¨æ„ï¼šéœ€è‡ªè¡Œå¤„ç†é”™è¯¯å’Œæ¸…ç†

+ å®Œæ•´è¯·æ±‚ç®¡ç†
  ğŸ‘‰ é€‰æ‹© vue-request
  âœ… ä¼˜ç‚¹ï¼šå†…ç½®é”™è¯¯é‡è¯•ã€ç¼“å­˜ã€èŠ‚æµç­‰é«˜çº§åŠŸèƒ½

+ å¤æ‚è½®è¯¢é€»è¾‘
  ğŸ‘‰ é‡‡ç”¨ RxJS
  âœ… ä¼˜ç‚¹ï¼šå¤„ç†ç«æ€æ¡ä»¶ã€é‡è¯•ç­–ç•¥ç­‰å¤æ‚åœºæ™¯å¾—å¿ƒåº”æ‰‹

+ éœ€è¦ç²¾ç»†æ§åˆ¶
  ğŸ‘‰ è‡ªè¡Œå°è£…ï¼ˆæ¨è usePolling æ–¹æ¡ˆï¼‰
  âœ… ä¼˜ç‚¹ï¼šå®Œå…¨å¯æ§ï¼Œé€‚åˆç‰¹æ®Šä¸šåŠ¡éœ€æ±‚









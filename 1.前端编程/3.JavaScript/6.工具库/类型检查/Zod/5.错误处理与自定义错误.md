# 错误处理与自定义错误

## 概述

+ 当 Zod 验证失败时，它会抛出（或在 safeParse 中返回）一个 ZodError 实例

## ZodError 对象结构

+ ZodError 对象有一个 issues 数组，其中每个 ZodIssue 对象描述了一个具体的验证问题。一个 ZodIssue 通常包含：

  + code: 错误类型码 (例如 invalid_type, too_small, custom)。
  + path: 一个数组，表示数据中发生错误的路径 (例如 ['user', 'address', 'zipCode'])。
  + message: 错误消息。
  + 其他特定于错误类型的属性 (例如 minimum 对于 too_small 错误)。


  ```js
  import { z } from 'zod';

  const schema = z.object({
    name: z.string().min(5, "名称至少5个字符"),
    age: z.number().positive(),
    contact: z.object({
      email: z.string().email(),
      phone: z.string().optional()
    })
  });

  const data = {
    name: "Joe", // 太短
    age: -30,    // 不是正数
    contact: {
      email: "not-an-email" // 无效邮箱
    }
  };

  const result = schema.safeParse(data);

  if (!result.success) {
    // result.error 是 ZodError 实例
    console.log("原始 ZodError issues:");
    result.error.issues.forEach(issue => {
      console.log(`  Path: ${issue.path.join('.')}, Message: ${issue.message}, Code: ${issue.code}`);
    });
    /*
    原始 ZodError issues:
      Path: name, Message: 名称至少5个字符, Code: too_small
      Path: age, Message: Number must be positive, Code: too_small
      Path: contact.email, Message: Invalid email, Code: invalid_string
    */
  }

  ```

## 扁平化错误 (.flatten())

+ ZodError 实例上有一个 .flatten() 方法，它可以将错误组织成更易于在 UI 中显示的结构。它返回一个对象，包含：

  + formErrors: 一个字符串数组，包含与整个表单/对象相关的错误 (通常是 refine 或 superRefine 在顶层对象上产生的错误)。
  + fieldErrors: 一个对象，键是字段路径，值是该字段的错误消息数组。

  ```js
  // ...接上例
  if (!result.success) {
    const flatErrors = result.error.flatten();
    console.log("\n扁平化后的错误 (fieldErrors):");
    for (const field in flatErrors.fieldErrors) {
      console.log(`  ${field}: ${flatErrors.fieldErrors[field].join(', ')}`);
    }
    if (flatErrors.formErrors.length > 0) {
        console.log("\n扁平化后的错误 (formErrors):");
        console.log(`  ${flatErrors.formErrors.join(', ')}`);
    }
    /*
    扁平化后的错误 (fieldErrors):
      name: 名称至少5个字符
      age: Number must be positive
      contact.email: Invalid email  (注意：flatten 默认不会递归到嵌套对象的子字段，除非你使用 .format())

    要获取更深层次的扁平化错误，通常使用 .format()，它会递归地为每个字段创建 _errors 数组。
    */

    const formattedErrors = result.error.format();
    console.log("\n格式化后的错误 (format()):");
    // console.log(JSON.stringify(formattedErrors, null, 2));
    if (formattedErrors.name) {
      console.log(`  Name errors: ${formattedErrors.name._errors.join(', ')}`);
    }
    if (formattedErrors.age) {
      console.log(`  Age errors: ${formattedErrors.age._errors.join(', ')}`);
    }
    if (formattedErrors.contact && formattedErrors.contact.email) {
      console.log(`  Contact Email errors: ${formattedErrors.contact.email._errors.join(', ')}`);
    }
    /*
    格式化后的错误 (format()):
      Name errors: 名称至少5个字符
      Age errors: Number must be positive
      Contact Email errors: Invalid email
    */
  }

  ```

+ .format() 方法提供了更结构化的错误输出，每个字段下都有一个 _errors 数组。

## 自定义错误信息

+ 几乎所有的 Zod 校验方法都接受一个可选的 message 参数或一个包含 message 的对象参数，用于自定义该特定校验失败时的错误信息

  ```js
  import { z } from 'zod';

  const usernameSchema = z.string()
    .min(3, { message: "用户名太短了，至少需要3个字符！" })
    .max(15, { message: "用户名太长了，最多15个字符！" });

  const ageSchema = z.number({
    required_error: "年龄是必填项", // 如果字段缺失 (在对象中且非 optional)
    invalid_type_error: "年龄必须是一个数字", // 如果类型不匹配
  }).positive({ message: "年龄必须大于0" });

  const userSchema = z.object({
      username: usernameSchema,
      age: ageSchema
  });

  console.log(userSchema.safeParse({ username: "Al", age: "twenty" }));
  /*
  {
    success: false,
    error: ZodError ... issues: [
      { code: 'too_small', path: [ 'username' ], message: '用户名太短了，至少需要3个字符！', ... },
      { code: 'invalid_type', path: [ 'age' ], message: '年龄必须是一个数字', ... }
    ]
  }
  */
  ```

# 完全自定义ContextPad

## 概述

+ 处理方式基本和之前一致，我们还是在src/components/customModeler/custom下创建一个新文件，CustomContextPadProvider.js

  ```js
  export default function ContextPadProvider(
    contextPad,
    config,
    injector,
    translate,
    bpmnFactory,
    elementFactory,
    create,
    modeling
  ) {
    this.create = create;
    this.elementFactory = elementFactory;
    this.translate = translate;
    this.bpmnFactory = bpmnFactory;
    this.modeling = modeling;
    config = config || {};
    if (config.autoPlace !== false) {
      this._autoPlace = injector.get("autoPlace", false);
    }
    contextPad.registerProvider(this);
  }

  ContextPadProvider.$inject = [
    "contextPad",
    "config",
    "injector",
    "translate",
    "bpmnFactory",
    "elementFactory",
    "create",
    "modeling"
  ];

  ContextPadProvider.prototype.getContextPadEntries = function (element) {};

  ```

+ ContextPadProvider.prototype.getContextPadEntries里面的代码和之前一致：

  ```js
  ContextPadProvider.prototype.getContextPadEntries = function (element) {
    const { autoPlace, create, elementFactory, translate, modeling } = this;

    function appendTask(event, element) {
      // 自动插入到默认位置
      if (autoPlace) {
        const shape = elementFactory.createShape({ type: "bpmn:Task" });
        autoPlace.append(element, shape);
      } else {
        // 进入拖拽模式，让用户自己放置
        appendTaskStart(event, element);
      }
    }

    function appendTaskStart(event) {
      const shape = elementFactory.createShape({ type: "bpmn:Task" });
      create.start(event, shape, element);
    }

    // 编辑元素
    function editElement() {
      return {
        group: "edit",
        className: "icon-custom icon-custom-edit",
        title: translate("编辑"),
        action: {
          click: clickElement,
        },
      };
    }
    // 删除元素
    function deleteElement() {
      return {
        group: "edit",
        className: "icon-custom icon-custom-delete",
        title: translate("删除"),
        action: {
          click: removeElement,
        },
      };
    }
    // 删除功能
    function removeElement(e) {
      modeling.removeElements([element]);
    }

    function clickElement(e) {
      console.log(element, e);
    }

    return {
      "append.duyi-task-icon": {
        group: "model",
        className: "icon-custom duyi-task",
        title: translate("创建一个类型为duyi-task-icon的任务节点"),
        action: {
          click: appendTask,
          dragstart: appendTaskStart,
        },
      },
      edit: editElement(),
      delete: deleteElement(),
    };
  };
  ```

## 将节点的信息传递出去

+ 之前的编辑事件中，我们处理了点击事件，但是仅仅就只是打印了一下信息

  ```js
  function clickElement(e) {
    console.log(element, e);
  }
  ```

+ 如果这些信息想要在一个弹出层中进行显示，就需要将信息传递出去，其实就是保存一个状态，我们可以使用localstorage，也可以使用状态管理，比如pinia，为了弹出层方便，这直接引入了element-plus

  ```js
  pnpm add pinia element-plus
  ```

+ 创建stores文件夹

  ```js
  // index.ts
  import { createPinia } from "pinia";
  export * from "./bpmn";

  const pinia = createPinia();
  export default pinia;
  ```

  ```js
  // bpmn.ts

  import { defineStore } from "pinia";

  interface BpmnState {
    id: string;
    type: string;
    height: number;
    width: number;
    x: number;
    y: number;
  }

  export const useBpmnStore = defineStore("bpmn", {
    state: () => {
      return {
        nodeVisible: false,
        nodeInfo: {} as BpmnState
      }
    },
    actions: {
      toggleNodeVisible(visible: boolean) {
        this.nodeVisible = visible;
      },
      setNodeInfo(info: any) {
        this.nodeInfo = info;
      }
    }
  });
  ```

  ```js
  // main.ts
  import pinia from "@/stores";
  import ElementPlus from "element-plus";
  import "element-plus/dist/index.css";

  createApp(App).use(pinia).use(ElementPlus).mount("#app");
  ```

+ 在ContextPadProvider.js文件中引用，由于useStore() 给你的 app 自动注入了 pinia 实例，但是在组件外就不行了，Pinia 需要一个“激活的应用实例”，但纯 JS 文件里没有，我们可以手动激活

  ```js
  import { useBpmnStore } from "@/stores/bpmn";
  import pinia from '@/stores'  // 需要导出 pinia 实例
  import { setActivePinia } from 'pinia'

  setActivePinia(pinia) // 手动激活
  const bpmnStore = useBpmnStore();

  ......
  function clickElement(e) {
    console.log(element, e);
    bpmnStore.toggleNodeVisible(true);
    bpmnStore.setNodeInfo(element);
  }

  ```

+ vue页面中引入：

  ```html
  <template>
    <div class="containers">
      <div class="canvas" ref="canvasRef" />
      <el-dialog
        v-model="bpmnStore.nodeVisible"
        title="Tips"
        width="500"
        :before-close="handleClose"
      >
        <div>{{ bpmnStore.nodeInfo.id }}</div>
        <div>{{ bpmnStore.nodeInfo.type }}</div>
        <template #footer>
          <div class="dialog-footer">
            <el-button type="primary" @click="handleClose">
              关闭
            </el-button>
          </div>
        </template>
      </el-dialog>
    </div>
  </template>

  <script setup lang="ts">
  // ......
  import { useBpmnStore } from "@/stores/bpmn.js";
  const bpmnStore = useBpmnStore();

  const handleClose = () => {
    bpmnStore.toggleNodeVisible(false);
  };
  </script>
  ```

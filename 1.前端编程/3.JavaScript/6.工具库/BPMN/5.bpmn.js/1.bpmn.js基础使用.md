# bpmn.js基础使用

## 概述

+ bpmn.js 提供了两套核心能力：

  ![alt text](images/bpmn.js核心能力.png)

## 注意:

+ bpmn.js 本身不负责流程执行，它只负责 BPMN 2.0 文件的可视化和编辑
+ 要让它和 Flowable（或 Camunda、Activiti 等工作流引擎）结合，你需要在前端（bpmn.js） 和 后端（Flowable Engine） 之间建立 BPMN XML 文件的交互

## 使用步骤

+ 要在工程中使用bpmn.js特别简单，只需要下面几步：

1. 引入相关包

  ```json
  "bpmn-js": "18.6.3",
  "diagram-js": "15.3.0"
  ```

2. 默认的流程xml文件

3. 显示容器

4. 创建bpmn相关对象

## 示例bpmn文件

+ 示例bpmn文件

  ```js
  export const xmlStr = `
  <?xml version="1.0" encoding="UTF-8"?>
  <!--
    一个最小可运行的 BPMN 2.0 示例
    包含：开始事件 → 用户任务 → 结束事件
  -->
  <definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
              xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
              xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
              xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              targetNamespace="http://bpmn.io/schema/bpmn">

    <!-- 1. 定义一个流程 -->
    <process id="Process_1" isExecutable="true">

      <!-- 开始事件 -->
      <startEvent id="StartEvent_1" name="开始" />

      <!-- 用户任务 -->
      <userTask id="UserTask_1" name="执行任务" />

      <!-- 结束事件 -->
      <endEvent id="EndEvent_1" name="结束" />

      <!-- 顺序流（连接三者） -->
      <sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="UserTask_1" />
      <sequenceFlow id="Flow_2" sourceRef="UserTask_1" targetRef="EndEvent_1" />

    </process>

    <!-- 2. 图形信息 (BPMN Diagram Interchange) -->
    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
      <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">

        <!-- 开始事件图形 -->
        <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
          <omgdc:Bounds x="150" y="100" width="36" height="36" />
        </bpmndi:BPMNShape>

        <!-- 用户任务图形 -->
        <bpmndi:BPMNShape id="UserTask_1_di" bpmnElement="UserTask_1">
          <omgdc:Bounds x="240" y="80" width="100" height="80" />
        </bpmndi:BPMNShape>

        <!-- 结束事件图形 -->
        <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
          <omgdc:Bounds x="400" y="100" width="36" height="36" />
        </bpmndi:BPMNShape>

        <!-- 顺序流连线 -->
        <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
          <omgdi:waypoint x="186" y="118" />
          <omgdi:waypoint x="240" y="118" />
        </bpmndi:BPMNEdge>

        <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
          <omgdi:waypoint x="340" y="118" />
          <omgdi:waypoint x="400" y="118" />
        </bpmndi:BPMNEdge>

      </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
  </definitions>
  `;

  ```

## Viewer

+ 基本概念就是创建一个 Dom 节点来挂载画布元素

  ```html
  <!-- BpmnViewer.vue -->
  <template>
    <div
      class="bpmn-viewer-container"
      ref="viewerContainer"
      style="width: 100%; height: 600px; border: 1px solid #ccc"
    />
  </template>

  <script setup lang="ts">
  import { onBeforeUnmount, onMounted, ref } from "vue";
  import BpmnViewer from "bpmn-js/lib/Viewer";
  // import BpmnViewer from 'bpmn-js/lib/NavigatedViewer'
  import { xmlStr } from '../mock/xmlStr'
  import type Canvas from "diagram-js/lib/core/Canvas";

  const viewerContainer = ref<HTMLDivElement | null>(null);
  let viewer: BpmnViewer | null = null;

  onMounted(async () => {
    if (!viewerContainer.value) return;
    viewer = new BpmnViewer({
      container: viewerContainer.value,
    });

    await viewer.importXML(xmlStr);

    const canvas = viewer.get<Canvas>("canvas");
    canvas.zoom("fit-viewport");
  })

  onBeforeUnmount(() => {
    if (viewer) {
      viewer.destroy();
      viewer = null;
    }
  });
  </script>

  <style scoped>
  </style>
  ```

## Modeler

+ Modeler

  ```html
  <!-- BpmnModeler.vue -->
  <template>
    <div class="containers">
      <div class="canvas" ref="canvasRef" />
    </div>
  </template>

  <script setup lang="ts">
  import { ref, onMounted, onBeforeUnmount } from "vue";
  import Modeler from "bpmn-js/lib/Modeler";
  import { xmlStr } from "../mock/xmlStr";
  import type Canvas from "diagram-js/lib/core/Canvas";

  // 左边工具栏以及编辑节点的样式
  import "bpmn-js/dist/assets/diagram-js.css";
  import "bpmn-js/dist/assets/bpmn-js.css";
  import "bpmn-js/dist/assets/bpmn-font/css/bpmn-embedded.css";

  const canvasRef = ref<HTMLDivElement | null>(null);
  let modeler: Modeler | null = null;

  onMounted(async () => {
    if (!canvasRef.value) return;

    modeler = new Modeler({
      container: canvasRef.value,
    });

    await loadXml(xmlStr);

    // 让画布适配
    const canvas = modeler.get<Canvas>("canvas");
    canvas.zoom("fit-viewport");

  });

  async function loadXml(xml: string) {
    if (!modeler) return;
    try {
      await modeler.importXML(xml);
    } catch (e) {
      console.error("importXML error:", e);
    }
  }

  onBeforeUnmount(() => {
    modeler?.destroy();
    modeler = null;
  });
  </script>

  <style scoped>
  .containers {
    position: relative;
    background-color: #ffffff;
    width: 100%;
    height: calc(100vh - 52px);
  }
  .canvas {
    width: 100%;
    height: 100%;
  }
  .panel {
    position: absolute;
    right: 0;
    top: 0;
    width: 300px;
  }
  button {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #f6f6f6;
  }
  </style>

  ```

## 加入properties-panel

+ 导入相关库：

  ```js
  "bpmn-js-properties-panel": "^5.42.0",
  "@bpmn-io/properties-panel": "^3.33.0"
  ```

  ```html
  <template>
    <div class="containers">
      <div class="canvas" ref="canvasRef" />
      <div class="panel" id="js-properties-panel"></div>
    </div>
  </template>

  <script setup lang="ts">
  import { ref, onMounted, onBeforeUnmount } from "vue";
  import Modeler from "bpmn-js/lib/Modeler";
  import { xmlStr } from "../mock/xmlStr";
  import type Canvas from "diagram-js/lib/core/Canvas";

  // 左边工具栏以及编辑节点的样式
  import "bpmn-js/dist/assets/diagram-js.css";
  import "bpmn-js/dist/assets/bpmn-js.css";
  import "bpmn-js/dist/assets/bpmn-font/css/bpmn-embedded.css";

  import {
    BpmnPropertiesPanelModule,
    BpmnPropertiesProviderModule,
  } from "bpmn-js-properties-panel";

  // 加入属性控制面板的样式
  import '@bpmn-io/properties-panel/assets/properties-panel.css';

  const canvasRef = ref<HTMLDivElement | null>(null);
  let modeler: Modeler | null = null;

  onMounted(async () => {
    if (!canvasRef.value) return;

    modeler = new Modeler({
      container: canvasRef.value,
      //添加控制板
      propertiesPanel: {
        parent: "#js-properties-panel",
      },
      additionalModules: [
        BpmnPropertiesPanelModule,
        BpmnPropertiesProviderModule,
      ],
    });

    await loadXml(xmlStr);

    // 让画布适配
    const canvas = modeler.get<Canvas>("canvas");
    canvas.zoom("fit-viewport");
  });

  async function loadXml(xml: string) {
    if (!modeler) return;
    try {
      await modeler.importXML(xml);
    } catch (e) {
      console.error("importXML error:", e);
    }
  }

  onBeforeUnmount(() => {
    modeler?.destroy();
    modeler = null;
  });
  </script>

  <style scoped>
  .containers {
    position: relative;
    background-color: #ffffff;
    width: 100%;
    height: calc(100vh - 52px);
  }
  .canvas {
    width: 100%;
    height: 100%;
  }
  .panel {
    position: absolute;
    right: 0;
    top: 0;
    width: 300px;
  }
  button {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #f6f6f6;
  }
  </style>

  ```

+ 由于bpmn-js-properties-panel库，并不支持ts，所以，为了方便，这里直接修改一下tsconfig的配置，tsconfig.app.json加下面的属性

  ```js
  "compilerOptions": {
    "skipLibCheck": true,
    "noImplicitAny": false,
  },
  ```

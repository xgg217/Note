# 加入新建、导入、导出等功能

## code

+ 加入新建、导入、导出等功能

  ```html
  <template>
    <div style="display: flex; flex-direction: column; gap: 8px">
      <div style="display: flex; align-items: center; gap: 8px">
        <button @click="handleNew">新建</button>

        <label style="display: inline-block">
          <span
            style="
              padding: 6px 10px;
              border: 1px solid #ccc;
              border-radius: 4px;
              cursor: pointer;
              display: inline-block;
            "
          >
            导入 XML
          </span>
          <input
            type="file"
            accept=".bpmn,.xml"
            style="display: none"
            @change="handleImport"
          />
        </label>

        <button @click="() => handleExportXML(true)">导出 XML</button>
        <button @click="handleExportSVG">导出 SVG</button>
      </div>
      <div class="containers">
        <div class="canvas" ref="canvasRef" />
        <div class="panel" id="js-properties-panel"></div>
      </div>
    </div>
  </template>

  <script setup lang="ts">
  import { ref, onMounted, onBeforeUnmount } from "vue";
  import Modeler from "bpmn-js/lib/Modeler";
  import { xmlStr } from "../mock/xmlStr";
  import type Canvas from "diagram-js/lib/core/Canvas";

  // 左边工具栏以及编辑节点的样式
  import "bpmn-js/dist/assets/diagram-js.css";
  import "bpmn-js/dist/assets/bpmn-js.css";
  import "bpmn-js/dist/assets/bpmn-font/css/bpmn-embedded.css";

  import {
    BpmnPropertiesPanelModule,
    BpmnPropertiesProviderModule,
  } from "bpmn-js-properties-panel";

  // 加入属性控制面板的样式
  import "@bpmn-io/properties-panel/assets/properties-panel.css";

  const canvasRef = ref<HTMLDivElement | null>(null);
  let modeler: Modeler | null = null;

  onMounted(async () => {
    if (!canvasRef.value) return;

    modeler = new Modeler({
      container: canvasRef.value,
      //添加控制板
      propertiesPanel: {
        parent: "#js-properties-panel",
      },
      additionalModules: [
        BpmnPropertiesPanelModule,
        BpmnPropertiesProviderModule,
      ],
    });

    await loadXml(xmlStr);

    // 让画布适配
    const canvas = modeler.get<Canvas>("canvas");
    canvas.zoom("fit-viewport");
  });

  async function loadXml(xml: string) {
    if (!modeler) return;
    try {
      await modeler.importXML(xml);
    } catch (e) {
      console.error("importXML error:", e);
    }
  }

  onBeforeUnmount(() => {
    modeler?.destroy();
    modeler = null;
  });

  // 新建：使用一份空白流程的模板
  async function handleNew() {
    const empty = `<?xml version="1.0" encoding="UTF-8"?>
  <bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
                    xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
                    xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
                    targetNamespace="http://bpmn.io/schema/bpmn">
    <bpmn:process id="Process_1" isExecutable="false"/>
    <bpmndi:BPMNDiagram id="BPMNDiagram_1">
      <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1"/>
    </bpmndi:BPMNDiagram>
  </bpmn:definitions>`;
    await loadXml(empty);
    const canvas = modeler!.get<Canvas>("canvas");
    canvas.zoom("fit-viewport");
  }

  // 导入本地 .bpmn
  async function handleImport(e: Event) {
    const input = e.target as HTMLInputElement;
    const file = input.files?.[0];
    if (!file) return;
    const text = await file.text();
    await loadXml(text);
    const canvas = modeler!.get<Canvas>("canvas");
    canvas.zoom("fit-viewport");
    input.value = "";
  }

  // 导出 XML
  async function handleExportXML(pretty = true) {
    if (!modeler) return;
    const { xml } = await modeler.saveXML({ format: pretty });
    download("diagram.bpmn", xml as string, "application/xml");
  }

  // 导出 SVG
  async function handleExportSVG() {
    if (!modeler) return;
    const { svg } = await modeler.saveSVG();
    download("diagram.svg", svg, "image/svg+xml");
  }

  // 下载辅助
  function download(filename: string, data: string, mime: string) {
    const blob = new Blob([data], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }
  </script>

  <style scoped>
  .containers {
    position: relative;
    background-color: #ffffff;
    width: 100%;
    height: calc(100vh - 52px);
  }
  .canvas {
    width: 100%;
    height: 100%;
  }
  .panel {
    position: absolute;
    right: 0;
    top: 0;
    width: 300px;
  }
  button {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #f6f6f6;
  }
  </style>

  ```


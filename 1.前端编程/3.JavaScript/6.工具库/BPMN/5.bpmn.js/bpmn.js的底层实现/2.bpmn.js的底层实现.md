# bpmn.js的底层实现

## 了解 bpmn-js 内部

+ 下面的内容和图片，均来自 https://bpmn.io/toolkit/bpmn-js/walkthrough/

+ 如下图所示，bpmn-js 建立在两个重要的库之上

  + diagram-js：绘制图形和连线

    + 它为我们提供了与这些图形元素进行交互的方法，以及诸如叠加层之类的其他工具，可以帮助用户构建功能强大的 BPMN 查看器
    + 对于诸如建模之类的高级用例，它提供了上下文内容面板，调色板和重做/撤消之类的功能

  + bpmn-moddle：知道 BPMN 2.0 标准中定义的 BPMN 2.0 元模型

    + 它使我们能够读写 BPMN 2.0 架构兼容的 XML 文档，并访问在图上绘制的图形和连线背后的 BPMN 相关信息

+ bpmn-js 体系结构:

  ![alt text](<images/bpmn-js 体系结构.png>)

+ 在这两个库的基础上，bpmn-js 定义了 BPMN 细节，例如外观，建模规则和工具（即调色板）

## 图表交互 / 建模（diagram-js）

+ diagram-js 是一个用于在 Web 上展示和修改图表的工具箱
+ 它允许我们渲染可视化元素，并在其之上构建交互式体验

+ 它提供了一个非常简单的模块系统，用于构建功能，并通过依赖注入（dependency injection）来实现服务发现

  + 这个系统同时还提供了一些核心服务，用于实现图表的基本功能

+ 此外，diagram-js 还定义了图形元素及其关系的数据模型

## 模块系统

+ 在底层，diagram-js 使用依赖注入（DI）来连接和发现图表组件。这个机制基于 didi 构建。

+ 在 diagram-js 的语境下，模块指的是提供具名服务及其实现的单元。所谓服务，可以是一个函数或一个实例，它可能会消费其他服务，在图表上下文中完成某些功能。

+ 下面展示了一个通过事件总线（eventBus，另一个常用服务）注册事件，从而挂载到生命周期事件的服务：

  ```js
  const MyLoggingPlugin = (eventBus) => {
    eventBus.on('element.changed', (event) => {
      console.log('element ', event.element, ' changed');
    });
  }
  // 静态 $inject 注入eventBus
  MyLoggingPlugin.$inject = [ 'eventBus' ];
  ```

+ 我们必须通过模块定义，将服务以唯一名称的方式发布：

  ```js
  import CoreModule from 'diagram-js/lib/core';

  // 作为模块导出
  export default {
    __depends__: [ CoreModule ], // {2}
    __init__: [ 'myLoggingPlugin' ], // {3}
    myLoggingPlugin: [ 'type', MyLoggingPlugin ] // {1}
  };
  ```

+ 这个定义告诉 DI 基础设施：该服务名为 myLoggingPlugin {1}，它依赖于 diagram-js 的核心模块 {2}，并且需要在图表创建时初始化 {3}。更多细节可以参考 didi 文档

+ 接下来我们可以启动 diagram-js，并传入自定义模块

  ```js
  import MyLoggingModule from 'path-to-my-logging-module';

  const diagram = new Diagram({
    modules: [
      MyLoggingModule
    ]
  });
  ```

+ 要将该模块接入 bpmn-js，可以使用 additionalModules 选项，就像我们之前展示的加入properties-panel那样

  ```js
  import BpmnModeler from "bpmn-js/lib/Modeler"

  const modeler = new BpmnModeler({
    // ...
    additionalModules: [MyLoggingModule]
  })
  ```

## 核心服务

+ diagram-js 核心是围绕许多基本服务构建的：

  + Canvas - 提供了 api 用于添加和删除图形元素；处理生命周期的元素，并提供 api 来缩放和滚动
  + EventBus - 这个库使用 fire 和 forget 策略的全局通信。相关模块可以订阅的各种事件，并在它们触发后立即采取行动。EventBus 可以帮助我们解耦问题，并且模块化功能。
  + ElementFactory - 用于根据 diagram-js 的内部数据模型创建图形和连线的工厂。
  + ElementRegistry - 知道添加到图表中的所有元素，并提供 API 来检索元素（通过 id）及其图形化表示。
  + GraphicsFactory - 负责创建图形和连线的图形表示。实际的外观由渲染器定义，即 draw module 模块内的 DefaultRenderer

## 数据模型

+ 在内部，diagramjs 实现了一个由图形和连线组成的简单数据模型。

  ![alt text](images/数据模型.png)

+ 一个图形有父对象、子对象集合以及传入和传出连线的集合。

+ 一个连线有一个父对象以及来源和目的，指向一个图形。

+ ElementRegistry 负责根据该模型创建图形和连线。在建模过程中，Modeling 服务将根据用户操作更新元素关系。

## 辅助服务（即工具箱）

+ 除了数据模型及其核心服务之外，diagram-js 还提供了一个丰富的工具箱，其中包含其他帮助程序。

  + CommandStack - 负责建模过程中的重做和撤消
  + ContextPad - 围绕提供元素的上下文操作
  + Overlays - 提供了用于图表元素的附加信息 api
  + Modeling - 提供用于更新画布上元素的 API（移动、删除）- 🙋‍♂️ 这个常用
  + Palette - 左侧工具栏

+ 总结一下：diagram-js 提供了一个通用、可扩展、可插拔的图形编辑框架，它不关心 BPMN 语义，只专注于图形 + 交互 + 模块化扩展

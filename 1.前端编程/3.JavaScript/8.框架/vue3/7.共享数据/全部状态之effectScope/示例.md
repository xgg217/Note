# 示例

## 基础示例

+ 基础示例

  ```js
  import { effectScope, reactive, watchEffect } from 'vue';

  // 1. 创建作用域
  const scope = effectScope();

  scope.run(() => {
    const state = reactive({ count: 0 });

    // 2. 在作用域内创建副作用（自动收集）
    watchEffect(() => {
      console.log('Count:', state.count);
    });

    // 3. 模拟依赖变化
    state.count++;
  });

  // 4. 停止作用域内的所有副作用
  scope.stop(); // 停止监听，控制台不再输出变化
  ```

## 创建一个带自动清理功能的计时器组合函数

+ 创建一个带自动清理功能的计时器组合函数

  ```js
  // useTimer.js
  import { effectScope, ref, watch, onScopeDispose } from "vue";

  // 可复用的计时器逻辑
  export function useTimer(interval = 1000) {
    const scope = effectScope(); // 创建作用域

    return scope.run(() => {
      const count = ref(0);
      const isActive = ref(true);

      let intervalId = null;

      // 副作用 1：响应式计时器
      watch(
        isActive,
        (active) => {
          if (active) {
            intervalId = setInterval(() => count.value++, interval);
            console.log("开始计时");
          } else {
            clearInterval(intervalId);
            console.log("暂停计时");
          }
        },
        { immediate: true }
      );

      // 副作用 2：自动清理
      onScopeDispose(() => {
        clearInterval(intervalId);
        console.log("停止计时");
      });

      // 暴露给使用者的 API
      return {
        count,
        pause: () => (isActive.value = false),//暂停
        resume: () => (isActive.value = true),//重新开始
        stop: () => scope.stop(), // 关键：一键停止所有副作用
      };
    });
  }
  ```

+ 使用

  ```html
  <!-- 使用 -->
  <template>
    <div class="container">
      <p>Count: {{ count }}</p>
      <button @click="pause">暂停</button>
      <button @click="resume">重新开始</button>
      <button @click="stop">停止</button>
    </div>
  </template>

  <script setup>
  import {onUnmounted} from 'vue'
  import { useTimer } from "./useTimer.js";

  const { count, pause, resume, stop } = useTimer();
  // 在组件卸载时停止所有副作用
  onUnmounted(() => {
    stop();
  });
  ```

## 复杂表单验证

+ 复杂表单验证

  ```html
  <script setup>
  import { effectScope, reactive, computed } from 'vue'

  const scope = effectScope()
  const form = reactive({
    username: '',
    email: '',
    password: '',
    confirmPassword: ''
  })

  const errors = reactive({})
  const isValid = computed(() =>
    Object.keys(errors).length === 0
  )

  scope.run(() => {
    // 用户名验证
    watch(() => form.username, (username) => {
      if (!username) {
        errors.username = '用户名不能为空'
      } else if (username.length < 3) {
        errors.username = '用户名至少3个字符'
      } else {
        delete errors.username
      }
    })

    // 邮箱验证
    watch(() => form.email, (email) => {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
      if (!email) {
        errors.email = '邮箱不能为空'
      } else if (!emailRegex.test(email)) {
        errors.email = '邮箱格式不正确'
      } else {
        delete errors.email
      }
    })

    // 密码一致性验证
    watch([() => form.password, () => form.confirmPassword],
      ([password, confirmPassword]) => {
        if (password !== confirmPassword) {
          errors.password = '两次输入的密码不一致'
        } else {
          delete errors.password
        }
      }
    )
  })

  // 组件卸载时清理所有验证逻辑
  onUnmounted(scope.stop)
  </script>

  ```

+ 表单草稿状态暂停验证

  ```js
  // 表单草稿状态暂停验证

  // 用户点击"保存草稿"时暂停验证
  const saveDraft=()=>{
    //暂停验证
    scope.pause()
    //提交数据逻辑
  }
  // 用户编辑草稿时恢复验证
  const editDraft=()=>{
  //恢复验证
    scope.resume()
  }
  ```

